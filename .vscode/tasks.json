# Spécification Technique - Stepper Création Client (3 étapes)

## Vue d'ensemble

Cette spécification décrit les modifications nécessaires pour implémenter un processus de création de client en 3 étapes (stepper) basé sur les maquettes fournies.

### Statut d'implémentation

| Élément                  | Statut |
| ------------------------ | ------ |
| Schema Prisma (Treasury) | 
| Schema Prisma (AccountingSystem) | 
| Suppression champs inutiles | 
| APIs Treasury            | 
| APIs Onboarding          | 
| Modification Services API | 

---

## Étapes du Stepper

| Étape | Nom                    | Description                                        |
| ----- | ---------------------- | -------------------------------------------------- |
| 1     | Informations générales | Données d'identification et adresse du client      |
| 2     | Trésorerie             | Informations de la trésorerie et données bancaires |
| 3     | Services autorisés     | Configuration des services et système comptable    |

---

## Étape 1 : Informations générales

### Champs UI

| Champ             | Type      | Obligatoire | Existant DB           | Notes                                  |
| ----------------- | --------- | ----------- | --------------------- | -------------------------------------- |
| Type de client    | Dropdown  | Oui         | ✅ `clientType`       | MAIRIE, CCAS, SYNDICAT, CENTRE_LOISIRS |
| SIRET             | Text (14) | Oui         | ✅ `siret`            | Validation 14 chiffres                 |
| Raison sociale    | Text      | Oui         | ✅ `name`             | Auto-rempli via API SIRET              |
| Adresse           | Text      | Oui         | ✅ `addressLine1`     | Auto-rempli via API SIRET              |
| Code postal       | Text (5)  | Oui         | ✅ `postalCode`       | Validation 5 chiffres                  |
| Ville             | Text      | Oui         | ✅ `city`             | Auto-rempli via API SIRET              |
| Code collectivité | Text      | Non         | ✅ `collectivityCode` | Optionnel                              |
| Code budget       | Text      | Non         | ✅ `budgetCode`       | Optionnel                              |
| Email             | Email     | Non         | ✅ `email`            | Optionnel                              |
| Téléphone         | Text      | Non         | ✅ `phone`            | Optionnel                              |


---

## Étape 2 : Trésorerie

### Champs UI

| Champ                | Type        | Obligatoire | Existant DB | Notes                     |
| -------------------- | ----------- | ----------- | ----------- | ------------------------- |
| Nom trésorerie       | Text        | Oui         | ❌          | Nouveau champ             |
| Adresse              | Text        | Oui         | ❌          | Nouveau champ             |
| Code postal          | Text (5)    | Oui         | ❌          | Validation 5 chiffres     |
| Ville                | Text        | Oui         | ❌          | Nouveau champ             |
| Horaires d'ouverture | Text        | Non         | ❌          | Format libre              |
| Email                | Email       | Non         | ❌          | Optionnel                 |
| Référence bancaire   | Text        | Oui         | ❌          | Obligatoire (ex: "BDDF")  |
| BIC                  | Text (8-11) | Oui         | ❌          | Validation BIC            |
| Référence IBAN       | Text (27)   | Oui         | ❌          | Validation IBAN           |
| Téléphone            | Text        | Non         | ❌          | Optionnel                 |
| N° codique           | Text        | Oui         | ❌          | Numéro codique trésorerie |
| Département          | Text (2-3)  | Oui         | ❌          | Code département          |
| Minimum facturé      | Decimal     | Non         | ❌          | Montant en euros          |

### Modifications Base de Données

#### Nouvelle table : `Treasury`

```prisma
model Treasury {
  id              String   @id @default(uuid())

  // Relation
  clientId        String   @unique @map("client_id")
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Identification
  name            String   @db.VarChar(255)
  codiqueNumber   String   @map("codique_number") @db.VarChar(50)
  department      String   @db.VarChar(3)

  // Adresse
  addressLine1    String   @map("address_line_1") @db.VarChar(255)
  addressLine2    String?  @map("address_line_2") @db.VarChar(255)
  postalCode      String   @map("postal_code") @db.VarChar(10)
  city            String   @db.VarChar(100)

  // Contact
  phone           String?  @db.VarChar(20)
  email           String?  @db.VarChar(255)
  openingHours    String?  @map("opening_hours") @db.VarChar(500)

  // Données bancaires
  bankReference   String   @map("bank_reference") @db.VarChar(50)
  bic             String   @db.VarChar(11)
  iban            String   @db.VarChar(34)

  // Facturation
  minimumBilling  Decimal? @map("minimum_billing") @db.Decimal(10, 2)

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("treasuries")
  @@index([clientId])
}
```

#### Modification table `Client`

Ajouter la relation inverse :

```prisma
model Client {
  // ... champs existants ...

  // Nouvelle relation
  treasury        Treasury?
}
```

---

## Étape 3 : Services autorisés

### Champs UI

| Champ                        | Type       | Obligatoire | Existant DB        | Notes                  |
| ---------------------------- | ---------- | ----------- | ------------------ | ---------------------- |
| Services activés             | Checkboxes | Oui (min 1) | ✅ `ClientService` | CANTEEN, DAYCARE, etc. |
| Max Configuration/service    | Number     | Oui         | ✅ `maxConfigs`    | Minimum 1              |
| Système de gestion comptable | Dropdown   | Oui         | ❌                 | Nouveau champ          |

### Modifications Base de Données

#### Nouvelle enum : `AccountingSystem`
ça peut etre vide


```prisma
enum AccountingSystem {

  BERGER_LEVRAULT // Berger-Levrault
  JVS             // JVS
  COSOLUCE        // Cosoluce

}
```

#### Modification table `Client`

Ajouter le champ système comptable :

```prisma
model Client {
  // ... champs existants ...

  // Système comptable
  accountingSystem AccountingSystem? @map("accounting_system")
}
```

---

## APIs à Développer / Modifier

### 1. Gestion Client (Step 1) - EXISTANT

#### 1.1 Créer un client

**Endpoint:** `POST /api/v1/clients`

Crée un nouveau client. L'API existante couvre déjà tous les champs de l'étape 1.
Le client est créé avec le status `DRAFT` et `onboardingStep = 1`.

#### 1.2 Modifier un client - NOUVEAU

**Endpoint:** `PATCH /api/v1/clients/:clientId`

Permet de modifier partiellement les informations générales du client (étape 1).
Utilisé quand l'utilisateur revient sur l'étape 1 pour corriger des informations.

**Request Body:** (tous les champs optionnels - seuls les champs fournis sont mis à jour)

```json
{
  "clientType": "MAIRIE",
  "name": "Mairie de Villebon-sur-Yvette",
  "collectivityCode": "COL-001",
  "budgetCode": "BUD-2024",
  "addressLine1": "1 Place du Marché",
  "addressLine2": null,
  "postalCode": "91140",
  "city": "Villebon-sur-Yvette",
  "email": "contact@villebon.fr",
  "phone": "0169311234"
}
```

**Response (200 OK):** ClientResponseDto

**Codes d'erreur:**
- `400` : Validation échouée
- `404` : Client non trouvé

> **Note:** `POST` crée, `PATCH` modifie. Le SIRET est  modifiable tant que le statut du client n'est pas égale à "ACTIF".

---

### 2. Gestion Trésorerie (Step 2) - NOUVEAU

#### 2.1 Créer/Modifier la trésorerie

**Endpoint:** `PUT /api/v1/clients/:clientId/treasury`

**Request Body:**

```json
{
  "name": "Trésorerie de Villebon",
  "codiqueNumber": "091234",
  "department": "91",
  "addressLine1": "15 Rue de la République",
  "addressLine2": null,
  "postalCode": "91140",
  "city": "Villebon-sur-Yvette",
  "phone": "0169123456",
  "email": "tresorerie.villebon@dgfip.gouv.fr",
  "openingHours": "Lundi-Vendredi 9h-12h, 14h-17h",
  "bankReference": "BDDF",
  "bic": "BDFEFRPP",
  "iban": "FR7630004000031234567890143",
  "minimumBilling": 0.5
}
```

**Response (200 OK):**

```json
{
  "id": "uuid",
  "clientId": "uuid",
  "name": "Trésorerie de Villebon",
  "codiqueNumber": "091234",
  "department": "91",
  "addressLine1": "15 Rue de la République",
  "postalCode": "91140",
  "city": "Villebon-sur-Yvette",
  "phone": "0169123456",
  "email": "tresorerie.villebon@dgfip.gouv.fr",
  "openingHours": "Lundi-Vendredi 9h-12h, 14h-17h",
  "bankReference": "BDDF",
  "bic": "BDFEFRPP",
  "iban": "FR7630004000031234567890143",
  "minimumBilling": 0.5,
  "createdAt": "2024-12-17T10:00:00Z",
  "updatedAt": "2024-12-17T10:00:00Z"
}
```

**Codes d'erreur:**

- `400` : Validation échouée (IBAN/BIC invalide, champs obligatoires manquants)
- `404` : Client non trouvé

---

#### 2.2 Récupérer la trésorerie

**Endpoint:** `GET /api/v1/clients/:clientId/treasury`

**Response (200 OK):**

```json
{
  "id": "uuid",
  "clientId": "uuid",
  "name": "Trésorerie de Villebon"
  // ... tous les champs
}
```

**Response (404):** Client ou trésorerie non trouvé

---

### 3. Configuration Services (Step 3) - MODIFICATION

#### 3.1 Mettre à jour les services - EXISTANT

**Endpoint:** `PUT /api/v1/clients/:clientId/services`

**Modification requise:** Ajouter le champ `accountingSystem` au payload.

**Nouveau Request Body:**

```json
{
  "accountingSystem": "MAGNUS",
  "services": [
    { "serviceType": "CANTEEN", "maxConfigs": 2 },
    { "serviceType": "DAYCARE", "maxConfigs": 3 }
  ]
}
```

**Response (200 OK):**

```json
{
  "clientId": "uuid",
  "clientName": "Mairie de Villebon-sur-Yvette",
  "accountingSystem": "MAGNUS",
  "services": [
    { "serviceType": "CANTEEN", "maxConfigs": 2 },
    { "serviceType": "DAYCARE", "maxConfigs": 3 }
  ]
}
```

---

#### 3.2 Récupérer les services - EXISTANT

**Endpoint:** `GET /api/v1/clients/:clientId/services`

**Modification requise:** Inclure `accountingSystem` dans la réponse.

**Nouvelle Response:**

```json
{
  "clientId": "uuid",
  "clientName": "Mairie de Villebon-sur-Yvette",
  "accountingSystem": "MAGNUS",
  "services": [
    { "serviceType": "CANTEEN", "maxConfigs": 2 },
    { "serviceType": "DAYCARE", "maxConfigs": 3 }
  ]
}
```

---

#### 3.3 Lister les systèmes comptables - NOUVEAU

**Endpoint:** `GET /api/v1/services/accounting-systems`

Retourne la liste des systèmes de gestion comptable disponibles.

**Response (200 OK):**

```json
[

  { "value": "BERGER_LEVRAULT", "label": "Berger-Levrault" },
  { "value": "JVS", "label": "JVS" },
  { "value": "COSOLUCE", "label": "Cosoluce" }

]
```

---

## Résumé des Modifications

### Base de Données

| Type  | Nom                       | Action | Description                         |
| ----- | ------------------------- | ------ | ----------------------------------- |
| Table | `Treasury`                | CREATE | Nouvelle table pour les trésoreries |
| Enum  | `AccountingSystem`        | CREATE | Enum pour systèmes comptables       |
| Champ | `Client.treasury`         | ADD    | Relation vers Treasury              |
| Champ | `Client.accountingSystem` | ADD    | Système comptable du client         |

### APIs

| Méthode | Endpoint                                        | Action | Description                       |
| ------- | ----------------------------------------------- | ------ | --------------------------------- |
| POST    | `/api/v1/clients`                               | EXISTE | Créer un client (Step 1)          |
| PATCH   | `/api/v1/clients/:clientId`                     | CREATE | Modifier infos client (Step 1)    |
| PUT     | `/api/v1/clients/:clientId/treasury`            | CREATE | Créer/modifier trésorerie (Step 2)|
| GET     | `/api/v1/clients/:clientId/treasury`            | CREATE | Récupérer trésorerie              |
| PUT     | `/api/v1/clients/:clientId/services`            | UPDATE | Ajouter accountingSystem (Step 3) |
| GET     | `/api/v1/clients/:clientId/services`            | UPDATE | Inclure accountingSystem          |
| GET     | `/api/v1/services/accounting-systems`           | CREATE | Lister systèmes comptables        |
| GET     | `/api/v1/clients/:clientId/onboarding-status`   | CREATE | Status progression onboarding     |


> Note: Les endpoints Treasury et Onboarding sont dans le module `clients` car ils sont sous `/clients/:clientId/...`

---

## Validations Requises

### IBAN (FR)

- Format : `FR` + 2 chiffres + 5 chiffres (banque) + 5 chiffres (guichet) + 11 caractères (compte) + 2 chiffres (clé)
- Regex : `^FR[0-9]{2}[0-9A-Z]{23}$`

### BIC

- Format : 8 ou 11 caractères alphanumériques
- Regex : `^[A-Z]{4}[A-Z]{2}[A-Z0-9]{2}([A-Z0-9]{3})?$`

### N° Codique

- Format numérique, généralement 6 chiffres
- Regex : `^[0-9]{4,10}$`

---

### N° Téléphone => ajouter une règle pour respecter le format en France

## Migration Prisma

```bash
# Générer la migration
npx prisma migrate dev --name add_treasury_and_accounting_system

# Appliquer en production
npx prisma migrate deploy
```

---

